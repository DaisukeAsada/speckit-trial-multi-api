# Feature Specification: ブログ記事管理・JWT認証APIサービス

**Feature Branch**: `001-blog-api-auth`  
**Created**: 2025-12-04  
**Status**: Draft  
**Input**: ブログ記事管理機能とJWT認証機能を持つAPIサービス

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ユーザー登録・ログイン (Priority: P1)

新規ユーザーがサービスに登録し、ログインして認証トークンを取得する。ログイン後、トークンを使用してAPIにアクセスできるようになる。

**Why this priority**: 認証はすべてのAPIアクセスの前提条件であり、これがなければ他の機能が利用できない。セキュリティの基盤となる最重要機能。

**Independent Test**: 新規ユーザーが登録し、ログインしてトークンを取得できることを確認。トークンなしでの保護されたリソースへのアクセスが拒否されることを検証。

**Acceptance Scenarios**:

1. **Given** 未登録のメールアドレスを持つユーザー, **When** 有効なメールアドレス、パスワード、名前で登録リクエストを送信する, **Then** ユーザーアカウントが作成され、成功レスポンスが返される
2. **Given** 登録済みのユーザー, **When** 正しいメールアドレスとパスワードでログインする, **Then** アクセストークンとリフレッシュトークンが返される
3. **Given** 登録済みのユーザー, **When** 間違ったパスワードでログインを試みる, **Then** 認証エラーが返され、トークンは発行されない
4. **Given** 未認証のリクエスト, **When** 保護されたエンドポイントにアクセスする, **Then** 401 Unauthorizedエラーが返される

---

### User Story 2 - 記事の作成・公開 (Priority: P2)

認証されたユーザーが新しいブログ記事を作成し、下書きとして保存または公開する。

**Why this priority**: コンテンツ作成はブログサービスの中核機能。認証の次に重要な機能として、ユーザーがコンテンツを生み出せるようにする。

**Independent Test**: 認証済みユーザーが記事を作成し、下書き/公開状態を設定できることを確認。未認証ユーザーが記事を作成できないことを検証。

**Acceptance Scenarios**:

1. **Given** 認証済みのユーザー, **When** タイトル、本文、著者名を含む記事作成リクエストを送信する, **Then** 新しい記事が作成され、UUIDと作成日時が割り当てられる
2. **Given** 認証済みのユーザー, **When** ステータスを「draft」として記事を作成する, **Then** 記事は下書きとして保存され、公開一覧には表示されない
3. **Given** 認証済みのユーザー, **When** ステータスを「published」として記事を作成する, **Then** 記事は公開され、一覧取得で表示される
4. **Given** 認証済みのユーザー, **When** タイトルが空の記事作成リクエストを送信する, **Then** バリデーションエラーが返される

---

### User Story 3 - 記事一覧の閲覧 (Priority: P3)

ユーザーが公開された記事の一覧を閲覧し、ページネーション、フィルタリング、ソートを使用して記事を探す。

**Why this priority**: 読者がコンテンツを発見できる機能。作成されたコンテンツを消費するための基本機能。

**Independent Test**: 記事一覧を取得し、ページネーション、ステータスフィルター、ソートが正しく動作することを確認。

**Acceptance Scenarios**:

1. **Given** 公開された記事が存在する, **When** 記事一覧APIを呼び出す, **Then** 公開済み記事の一覧がページネーション付きで返される
2. **Given** 記事が10件以上存在する, **When** page=2, limit=5で一覧を取得する, **Then** 6-10件目の記事が返される
3. **Given** 下書きと公開済みの記事が混在する, **When** status=publishedでフィルターする, **Then** 公開済みの記事のみが返される
4. **Given** 複数の記事が存在する, **When** sort=createdAt:descでソートする, **Then** 作成日時の降順で記事が返される

---

### User Story 4 - 記事の詳細閲覧 (Priority: P4)

ユーザーが特定の記事の詳細情報を閲覧する。

**Why this priority**: 個別記事へのアクセスは一覧閲覧の次のステップとして必要。

**Independent Test**: 記事IDを指定して記事詳細を取得できることを確認。存在しないIDの場合はエラーが返されることを検証。

**Acceptance Scenarios**:

1. **Given** 公開された記事が存在する, **When** その記事のIDで詳細APIを呼び出す, **Then** 記事のすべての情報（タイトル、本文、著者、ステータス、日時）が返される
2. **Given** 存在しない記事ID, **When** 詳細APIを呼び出す, **Then** 404 Not Foundエラーが返される

---

### User Story 5 - 記事の編集・削除 (Priority: P5)

認証されたユーザーが自分の記事を編集または削除する。

**Why this priority**: コンテンツ管理の完全性のために必要だが、作成・閲覧より後の優先度。

**Independent Test**: 認証済みユーザーが記事を更新・削除できることを確認。未認証ユーザーは操作できないことを検証。

**Acceptance Scenarios**:

1. **Given** 認証済みのユーザーと自分が作成した記事, **When** タイトルを変更する更新リクエストを送信する, **Then** 記事が更新され、updatedAtが更新される
2. **Given** 認証済みのユーザーと自分が作成した記事, **When** 削除リクエストを送信する, **Then** 記事が削除される
3. **Given** 下書き状態の記事, **When** ステータスをpublishedに変更する, **Then** 記事が公開される

---

### User Story 6 - トークン更新・ログアウト (Priority: P6)

ユーザーが期限切れになりそうなアクセストークンをリフレッシュトークンで更新し、ログアウトする。

**Why this priority**: セキュリティ運用上必要だが、基本的なログイン/操作より後の優先度。

**Independent Test**: リフレッシュトークンで新しいアクセストークンを取得できること、ログアウト後はトークンが無効化されることを確認。

**Acceptance Scenarios**:

1. **Given** 有効なリフレッシュトークンを持つユーザー, **When** トークン更新リクエストを送信する, **Then** 新しいアクセストークンが発行される
2. **Given** 期限切れのリフレッシュトークン, **When** トークン更新リクエストを送信する, **Then** エラーが返され、再ログインが必要
3. **Given** ログイン済みのユーザー, **When** ログアウトリクエストを送信する, **Then** リフレッシュトークンが無効化される

---

### Edge Cases

- 記事タイトルが200文字を超える場合、バリデーションエラーが返される
- 記事本文が64KBを超える場合、バリデーションエラーが返される
- 同一IPアドレスからログイン試行が1分間に5回を超えた場合、レート制限エラー（429）が返される
- アクセストークンの有効期限が切れた場合、401エラーとともに期限切れを示すメッセージが返される
- 同じメールアドレスで再度登録しようとした場合、重複エラーが返される
- 空の本文で記事を作成しようとした場合、バリデーションエラーが返される
- 不正な形式のUUIDで記事を取得しようとした場合、400 Bad Requestが返される
- 不正な形式のUUIDで記事を更新しようとした場合、400 Bad Requestが返される
- 不正な形式のUUIDで記事を削除しようとした場合、400 Bad Requestが返される

## Requirements *(mandatory)*

### Functional Requirements

#### 認証機能

- **FR-001**: システムはメールアドレスとパスワードによる新規ユーザー登録を提供しなければならない
- **FR-002**: システムはパスワードをbcryptでハッシュ化して保存しなければならない
- **FR-003**: システムはログイン成功時にアクセストークンとリフレッシュトークンを発行しなければならない
- **FR-004**: アクセストークンの有効期限は1時間としなければならない
- **FR-005**: リフレッシュトークンの有効期限は7日間としなければならない
- **FR-006**: システムはリフレッシュトークンを使用して新しいアクセストークンを発行できなければならない
- **FR-007**: システムはログアウト時にリフレッシュトークンを無効化しなければならない
- **FR-008**: 認証エンドポイントに対するリクエストは1分あたり5回に制限されなければならない
- **FR-024**: システムは認証イベント（ログイン成功/失敗、トークン発行/更新/無効化）をログに記録しなければならない

#### 記事管理機能

- **FR-009**: システムは認証されたユーザーによる記事の作成を許可しなければならない
- **FR-010**: 記事にはUUID形式のIDが自動的に割り当てられなければならない
- **FR-011**: 記事のタイトルは必須で、1〜200文字の範囲でなければならない
- **FR-012**: 記事の本文は必須で、最大64KB（約65,000文字）でなければならない
- **FR-013**: 記事の著者名は認証済みユーザーのUser.nameから自動的に設定されなければならない
- **FR-014**: 記事のステータスは「draft」または「published」でなければならない
- **FR-015**: 記事には作成日時と更新日時が自動的に記録されなければならない
- **FR-016**: システムは記事一覧取得時にページネーション（page, limit）をサポートしなければならない
- **FR-017**: システムは記事一覧取得時にステータスによるフィルタリングをサポートしなければならない
- **FR-018**: システムは記事一覧取得時にソート機能をサポートしなければならない
- **FR-019**: システムは認証されたユーザーによる自分の記事の更新を許可しなければならない
- **FR-020**: システムは認証されたユーザーによる自分の記事の物理削除を許可しなければならない（復元不可）
- **FR-022**: 管理者（role=admin）はすべての記事を編集・削除できなければならない
- **FR-023**: ユーザー登録時のデフォルトロールは「user」でなければならない
- **FR-021**: 記事の詳細取得は認証なしでアクセス可能でなければならない

### Key Entities

- **User**: サービスの利用者。メールアドレス（一意）、ハッシュ化されたパスワード、名前、ロール（user/admin）、登録日時を持つ。記事の作成者として関連付けられる。デフォルトロールは「user」。

- **Post（記事）**: ブログ記事。UUID形式のID、タイトル（1-200文字）、本文（最大64KB）、著者名（認証済みユーザーのUser.nameから自動設定）、ステータス（draft/published）、作成日時、更新日時を持つ。作成者のUserとの関連を持つ。

- **RefreshToken**: リフレッシュトークン情報。ユーザーとの関連、トークン値、有効期限、無効化フラグを持つ。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは登録からログインまでを30秒以内に完了できる
- **SC-002**: 記事作成リクエストから完了まで2秒以内で処理される
- **SC-003**: 記事一覧取得は100件のデータに対して1秒以内で応答する
- **SC-004**: 同時に100人のユーザーがアクセスしてもパフォーマンス低下なく動作する
- **SC-005**: 不正なログイン試行に対して100%レート制限が適用される
- **SC-006**: すべてのパスワードが暗号化されて保存されていることを検証できる
- **SC-007**: 期限切れトークンは100%拒否される
- **SC-008**: バリデーションエラーはユーザーにとって理解しやすいメッセージで返される

## Assumptions

本仕様は以下の前提に基づいて作成されています：

- 一般ユーザー（role=user）は自分が作成した記事のみ編集・削除できる
- 管理者（role=admin）はすべての記事を編集・削除できる
- 記事一覧のデフォルトのページサイズは20件とする
- 記事一覧のデフォルトのソートは作成日時の降順とする
- メールアドレスの形式バリデーションは標準的なRFC 5322に準拠する
- パスワードは8文字以上で、英数字を含むこととする

## Clarifications

### Session 2025-12-04

- Q: 記事の著者フィールドとユーザーの関係 → A: 認証済みユーザーのUser.nameを自動的にauthorとして設定する（ユーザー入力不可）
- Q: 他ユーザーの記事に対する編集・削除権限 → A: Adminロールを追加し、Adminはすべての記事を編集・削除可能
- Q: ログ・監視（Observability）要件 → A: 認証イベント（ログイン成功/失敗、トークン発行）のみログ記録
- Q: 記事本文の最大長制限 → A: 64KB（約65,000文字）を上限とする
- Q: 記事の論理削除 vs 物理削除 → A: 物理削除（完全に削除、復元不可、シンプルな実装）
- Q: 下書き記事の閲覧制限 → A: 現時点のスコープ外とする（将来的に作成者のみ閲覧可能な機能を追加する可能性あり）
